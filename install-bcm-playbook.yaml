---
- hosts: [bitcoin-congestion-manger_nodes]
  remote_user: root
  roles:
    - nodesource.node

  tasks:
    - name: Install bitcoind
      apt: name=bitcoind state=present

    - name: Install redis
      apt: name=redis state=present

    - name: Install supervisord
      apt: name=supervisor state=present

    - name: Install python3-pip
      apt: name=python3-pip state=present

    - name: Install crossbar
      pip:
        name: crossbar

    - name: Install htop
      apt: name=htop state=present

    - name: Install curl
      apt: name=curl state=present

    - name: Install git
      apt: name=git state=present

    - name: Get btc-congestion-manager
      git:
        name: https://github.com/dlebrecht/btc-congestion-manager.git
        dest: /app
      register: bcm

    - copy:
        src: /app/_env/bitcoind.super.conf
        dest: /etc/supervisor/conf.d
        remote_src: yes
      when: bcm.changed
      register: supervisor_config1

    - copy:
        src: /app/_env/crossbar.super.conf
        dest: /etc/supervisor/conf.d
        remote_src: yes
      when: bcm.changed
      register: supervisor_config2

    - copy:
        src: /app/_env/btc-congestion-manager.super.conf
        dest: /etc/supervisor/conf.d
        remote_src: yes
      when: bcm.changed
      register: supervisor_config3

    - name: Install app dependencies
      command: npm i
      args:
        chdir: /app
      when: bcm.changed

    - name: Compile tsc
      command: npm run build
      args:
        chdir: /app
      when: bcm.changed

    - supervisorctl:
        name: "{{ item }}"
        state: restarted
      with_items:
        - rest-server
        - crossbar
      when: supervisor_config1.changed or supervisor_config2.changed or supervisor_config3.changed
